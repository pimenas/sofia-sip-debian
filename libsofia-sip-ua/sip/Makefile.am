#
# Makefile.am for sip module
#

# ----------------------------------------------------------------------
# Header paths

INCLUDES = 	-I$(srcdir)/../bnf -I../bnf \
		-I$(srcdir)/../ipt -I../ipt \
		-I$(srcdir)/../msg -I../msg \
		-I$(srcdir)/../url -I../url \
		-I$(srcdir)/../su -I../su

# ----------------------------------------------------------------------
# Build targets

noinst_LTLIBRARIES = 	libsip.la

check_PROGRAMS =       torture_sip \
			sip_test_msg validator date_test

# ----------------------------------------------------------------------
# Rules for building the targets

GENERATED_H = 		sofia-sip/sip_hclasses.h \
			sofia-sip/sip_protos.h sofia-sip/sip_tag.h
H_IN = 			sofia-sip/sip_hclasses.h.in \
			sofia-sip/sip_protos.h.in sofia-sip/sip_tag.h.in

PUBLIC_H = sofia-sip/sip.h sofia-sip/sip_util.h \
           sofia-sip/sip_header.h sofia-sip/sip_parser.h \
	   sofia-sip/sip_tag_class.h sofia-sip/sip_status.h

GENERATED_C = sip_tag.c sip_tag_ref.c sip_parser_table.c

BUILT_SOURCES = 	$(GENERATED_H) $(GENERATED_C)

nobase_include_sofia_HEADERS = $(GENERATED_H) $(PUBLIC_H) $(H_IN)

libsip_la_SOURCES = 	$(INTERNAL_H) \
			sip_parser.c sip_header.c sip_util.c sip_pref_util.c \
			sip_basic.c sip_extra.c sip_feature.c sip_mime.c \
			sip_security.c sip_event.c sip_prack.c \
			sip_refer.c sip_session.c \
			sip_caller_prefs.c sip_reason.c \
			sip_status.c sip_time.c \
			sip_tag_class.c \
			$(GENERATED_C)

COVERAGE_INPUT = 	$(libsip_la_SOURCES) $(include_sofia_HEADERS)

LDADD = 		libsip.la \
			../msg/libmsg.la \
			../bnf/libbnf.la \
			../url/liburl.la \
			../su/libsu.la

torture_sip_LDFLAGS = 	-static
sip_test_msg_LDFLAGS = 	-static
date_test_LDFLAGS = 	-static

# ----------------------------------------------------------------------
# Install and distribution rules

# note: srcdir needs to be specified, otherwise
#       breaks make distcheck target

EXTRA_DIST =		Doxyfile sip.docs sip_parser.docs \
			ADD-A-HEADER GRAMMAR sip_bad_mask \
			sip_parser_table.c.in sip_tag.c.in \
			sip_bad_mask \
	images/sip-parser.eps images/sip-parser.gif \
	images/sip-parser2.eps images/sip-parser2.gif \
	images/sip-parser3.eps images/sip-parser3.gif \
	images/sip-parser4.eps images/sip-parser4.gif \
	tests/own0.txt tests/own1.txt tests/own2.txt tests/own3.txt \
	tests/own4.txt tests/own5.txt tests/own6.txt \
	tests/test1.txt tests/test-ack-1.txt tests/test2.txt tests/test3.txt \
	tests/test4.txt tests/test5.txt tests/test6.txt tests/test7.txt	     \
	tests/test8.txt tests/test9.txt tests/test10.txt tests/test10b.txt   \
	tests/test10c.txt tests/test11.txt tests/test12.txt tests/test13.txt \
	tests/test14-req.txt tests/test14.txt tests/test15.txt		     \
	tests/test16.txt tests/test17.txt tests/test18.txt tests/test19.txt  \
	tests/test1a.txt tests/test20.txt tests/test21.txt tests/test22.txt  \
	tests/test23.txt tests/test24.txt tests/test25.txt tests/test26.txt  \
	tests/test27.txt tests/test28.txt tests/test29.txt tests/test30.txt  \
	tests/test31.txt tests/test32.txt tests/test33.txt tests/test34.txt  \
	tests/test35.txt tests/test36.txt tests/test37.txt tests/test38.txt  \
	tests/test39.txt tests/test40.txt tests/test41.txt tests/test42.txt

# ----------------------------------------------------------------------
# Tests

TESTS = torture_sip run_sip_test_msg run_date_test

dist_noinst_SCRIPTS = 	run_sip_test_msg run_date_test

# ----------------------------------------------------------------------
# Sofia specific rules

include ../sofia.am

MSG_PARSER_AWK = $(srcdir)/../msg/msg_parser.awk

AWK_SIP_AWK = $(AWK) -f $(MSG_PARSER_AWK) module=sip

#
# Note: sip_bad_mask is used by nta to weed out bad messages
#
sip_parser_table.c: sip_bad_mask

sofia-sip/sip_hclasses.h: sofia-sip/sip_hclasses.h.in
sofia-sip/sip_protos.h: sofia-sip/sip_protos.h.in
sofia-sip/sip_tag.h: sofia-sip/sip_tag.h.in

$(GENERATED_H): $(MSG_PARSER_AWK)

sip_parser_table.c: sip_parser_table.c.in $(MSG_PARSER_AWK)
sip_tag.c: sip_tag.c.in $(MSG_PARSER_AWK)

sofia-sip/sip_hclasses.h: sofia-sip/sip.h
	@-mkdir sofia-sip 2>/dev/null || true
	$(AWK_SIP_AWK) PR=$@ TEMPLATE=$(srcdir)/sofia-sip/sip_hclasses.h.in $<

sofia-sip/sip_protos.h: sofia-sip/sip.h
	@-mkdir sofia-sip 2>/dev/null || true
	$(AWK_SIP_AWK) PR=$@ TEMPLATE=$(srcdir)/sofia-sip/sip_protos.h.in $<

sofia-sip/sip_tag.h: sofia-sip/sip.h
	@-mkdir sofia-sip 2>/dev/null || true
	$(AWK_SIP_AWK) PR=$@ TEMPLATE=$(srcdir)/sofia-sip/sip_tag.h.in $<

sip_tag.c: sofia-sip/sip.h
	$(AWK_SIP_AWK) PR=$@ TEMPLATE=$(srcdir)/sip_tag.c.in $<

sip_parser_table.c: sofia-sip/sip.h
	$(AWK_SIP_AWK) PT=$@ TEMPLATE=$(srcdir)/sip_parser_table.c.in \
		FLAGFILE=$(srcdir)/sip_bad_mask \
		MC_HASH_SIZE=127 MC_SHORT_SIZE=26 $<
